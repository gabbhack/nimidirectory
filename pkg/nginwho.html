<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">nginwho</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">nginx</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">linux</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">nginx log parser</button></a>
                </span>
            
        </p>
        
            <p class="pkg-desc">A lightweight and extremely fast nginx log parser that stores the result into a sqlite3 database for further analysis and action</p>
        
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install nginwho" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h1>nginwho</h1>
<div align="center" style="width: 100%;">
 <img src="https://github.com/pouriyajamshidi/nginwho/blob/master/artwork/nginwho.jpeg?raw=true" style="max-width: 100%;" width="700" alt="nginwho" />
</div>
<hr />
<p><strong>nginwho</strong> is a lightweight, efficient and extremely fast program offering:</p>
<ol>
<li><a href="#nginx-log-parser">nginx log parser</a>: Stores nginx logs into a <strong>sqlite3</strong> database for further analysis and actions</li>
<li><a href="#restore-cloudflare-original-visitor-ip">Restore Cloudflare</a> original visitor IP: Continuously parses <strong>Cloudflare CIDRs</strong> (<code>IPv4</code> and <code>IPv6</code>) through their <strong>API</strong>s so that nginx can leverage it to restore the original IP address of visitors</li>
<li><a href="#block-untrusted-requests">Block untrusted</a> requests using <strong>nftables</strong> to prevent HTTP and HTTPS requests coming from unknown IP addresses</li>
<li><a href="#reporting">Reporting</a> on gathered data such as top visited URLs through a TUI</li>
</ol>
<p>Table of contents:</p>
<ul>
<li><a href="#nginwho">nginwho</a>
<ul>
<li>  <a href="#usage">Usage</a></li>
<li>  <a href="#flags">Flags</a></li>
<li><a href="#how-it-works">How it works</a>
<ul>
<li>  <a href="#nginx-log-parser">nginx Log Parser</a></li>
<li>  <a href="#restore-cloudflare-original-visitor-ip">Restore Cloudflare Original Visitor IP</a></li>
<li>  <a href="#block-untrusted-requests">Block Untrusted Requests</a></li>
<li>  <a href="#reporting">Reporting</a></li>
<li>  <a href="#migrating-v1-database-to-v2">Migrating v1 database to v2</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>Usage</h2>
<blockquote>
<p>[!IMPORTANT]
If you have been a user since version 1, please check out <a href="#migrating-v1-database-to-v2">this section</a> to migrate your database scheme to version 2.</p>
</blockquote>
<ol>
<li>
<p>Download <strong>nginwho</strong> from this URL:</p>
<pre>  <code class="language-bash">wget https://github.com/pouriyajamshidi/nginwho/releases/latest/download/nginwho
</code></pre>
<p>Optionally, <strong>nginwho</strong> can also be installed using nimble:</p>
<pre>  <code class="language-bash">nimble install nginwho
</code></pre>
</li>
<li>
<p>Make it executable and move it to your <code>$PATH</code>:</p>
<pre>  <code class="language-bash">chmod +x nginwho
sudo cp nginwho /usr/local/bin
</code></pre>
</li>
<li>
<p>Run it:</p>
<pre>  <code class="language-bash"> nginwho --logPath:/var/log/nginx/access.log --dbPath:/var/log/nginwho.db

 # If you want to omit a certain referrer from being logged (replace thegraynode.io with your domain):
 nginwho --logPath:/var/log/nginx/access.log \
         --dbPath:/var/log/nginwho.db \
         --omitReferrer:thegraynode.io

 # If you want to get real IP addresses of the visitors coming from Cloudflare:
 nginwho --logPath:/var/log/nginx/access.log \
         --dbPath:/var/log/nginwho.db \
         --showRealIps:true
</code></pre>
</li>
</ol>
<blockquote>
<p>Please note that you can mix these flags. They operate independently.</p>
</blockquote>
<ol>
<li>
<p>Optionally, use the <a href="https://github.com/pouriyajamshidi/nginwho/blob/master/nginwho.service">accompanying systemd</a> to run <strong>nginwho</strong> as a service in the background and for the it to survive system reboots:</p>
<pre>  <code class="language-bash">sudo cp nginwho.service /etc/systemd/system/nginwho.service
sudo systemctl enable nginwho.service
sudo systemctl start nginwho.service
</code></pre>
</li>
</ol>
<h2>Flags</h2>
<p>Here are the available flags:</p>
<pre>  <code class="language-text">  --help, -h              : Show help
  --version, -v           : Display version and quit
  --dbPath,               : Path to SQLite database to log reports (default: /var/log/nginwho.db)
  --logPath,              : Path to nginx access logs (default: /var/log/nginx/access.log)
  --interval              : Refresh interval in seconds (default: 10)
  --omitReferrer          : Omit a specific referrer from being logged (default: none)
  --showRealIps           : Show real IP of visitors by getting Cloudflare CIDRs to include in nginx config.
                            Self-updates every six hours (default: false)
  --blockUntrustedCidrs   : Block untrusted IP addresses using nftables. Only allows Cloudflare CIDRs (default: false)
  --processNginxLogs      : Process nginx logs (default: true)
  --report                : Enter report mode and query the database for statistics

  --migrateV1ToV2Db       : Migrate V1 database to V2 and exit (default: false).
                            Use with &apos;--v1DbPath&apos; and &apos;--v2DbPath&apos; flags
  --v1DbPath              : Path and name of the V1 database (e.g: /var/log/nginwho_v1.db)
  --v2DbPath              : Path and name of the V2 database (e.g: /var/log/nginwho.db)

</code></pre>
<h2>How it works</h2>
<p>Let&apos;s see how nginwho works in a somewhat detailed yet short fashion.</p>
<h3>nginx Log Parser</h3>
<p><strong>nginwho</strong> by default reads <code>nginx</code> logs from <code>/var/log/nginx/access.log</code> and stores the parsed results in a <strong>sqlite3</strong> database located in <code>/var/log/nginwho.db</code> unless overridden by the <a href="#flags">available flags</a>.</p>
<blockquote>
<p>[!WARNING]
nginwho only supports the default nginx log format or any application that logs in the same format for now</p>
</blockquote>
<h3>Restore Cloudflare Original Visitor IP</h3>
<p>The second feature, <code>--showRealIps</code> flag fetches <strong>Cloudflare CIDRs</strong> (<code>IPv4</code> and <code>IPv6</code>) every <em>six hours</em> through their <strong>API</strong>s and writes the result to a file named <code>nginwho</code> located in <code>/etc/nginx/</code>.</p>
<p>It is worthwhile to mention that <strong>nginwho</strong> leverages the <code>etag</code> field in Cloudflare&apos;s API response, so, if the newly fetched <code>etag</code> is the same as the current one, the <code>/etc/nginx/nginwho</code> file will not be overwritten.</p>
<p>If the <code>/etc/nginx/nginwho</code> file has changed or this is a fresh run, <strong>nginwho</strong> schedules the <strong>nginx</strong> service to be soft reloaded (<code>nginx -s reload</code>) at 3 AM.</p>
<blockquote>
<p>[!IMPORTANT]
The <code>--showRealIps</code> flag requires <strong>root privileges</strong>.</p>
</blockquote>
<p>For <code>--showRealIps</code> flag to work, you need to alter your <strong>nginx</strong> configuration add this line to include the generated configuration inside the <code>/etc/nginx/nginwho</code> file:</p>
<pre>  <code class="language-text">include /etc/nginx/nginwho;
</code></pre>
<p>So that nginx knows how to restore original visitor IP addresses.</p>
<h3>Block Untrusted Requests</h3>
<p>The third feature, <code>--block-untrusted-cidrs</code> flag periodically gets Cloudflare CIDRs, either through:</p>
<ol>
<li>Cloudflare APIs when used in conjunction with <code>--showRealIps</code> flag</li>
<li>or the <code>/etc/nginx/nginwho</code> file when the <code>--showRealIps</code> flag is not specified</li>
</ol>
<p>The fetched CIDRs will be checked against your existing <strong>nftables</strong> rules and if necessary, the required rules will be created and added through <em>nftable&apos;s JSON API</em>.</p>
<p>There will be a bunch of tests and pre-checks done before applying any policies. These checks include:</p>
<ol>
<li>Existence of Cloudflare IPv4 CIDRs nftables <em>Set</em> (<code>Cloudflare_IPv4</code>)</li>
<li>Existence of Cloudflare IPv6 CIDRs nftables <em>Set</em> (<code>Cloudflare_IPv6</code>)</li>
<li>Existence of nftables <code>nginwho</code> chain (<code>prerouting</code> hook)</li>
<li>Existence of nftables <code>input</code> chain</li>
<li>Existence of <strong>drop</strong> policy inside <code>nginwho</code> chain for untrusted IP addresses on port <strong>80</strong> and <strong>443</strong></li>
<li>Existence of <strong>accept</strong> policy inside <code>input</code> chain for trusted IP addresses on port <strong>80</strong> and <strong>443</strong></li>
</ol>
<p><strong>nginwho</strong> only creates the necessary changes. Otherwise, no actions will be taken. For instance, if a CIDR gets added or removed, only that part of <strong>nftables</strong> configuration will be changed and the rest remain unchanged.</p>
<blockquote>
<p>[!IMPORTANT]
Since playing with <strong>nftables</strong> could result in blocking yourself out, <strong>nginwho</strong> requires you to have some basic policies in place, in specific, having an <code>inet filter</code> table. If you do not have it, <strong>nginwho</strong> will detect that and shows you how to create one.</p>
</blockquote>
<h3>Reporting</h3>
<p>Running <strong>nginwho</strong> with the <code>--report</code> flag will launch a TUI, providing some options (top visited URLs, top visiting IP addresses, etc.) that you can select and specify how many records to be queried.</p>
<pre>  <code class="language-bash">nginwho --report --dbPath:/var/log/nginwho.db
</code></pre>
<h3>Migrating v1 database to v2</h3>
<p>Running the command below will first check your database for any errors and, if it detects any, will output what recovery command should be run. If everything is fine, it will read out the data from your source database, convert and write the data to version 2 so that nginwho can continue working as intended.</p>
<blockquote>
<p>Also, please be noted to change the database file names according to your setup.</p>
</blockquote>
<pre>  <code class="language-bash">nginwho --migrateV1ToV2:true \
        --v1DbPath:nginwho_v1.db \
        --v2DbPath:nginwho.db \
</code></pre>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        MIT
                    </p>
                

                
                    <p> <a href="https://github.com/pouriyajamshidi/nginwho">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2024-12-03T01:45:31Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
