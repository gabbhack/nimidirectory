<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">cdp</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">cdp</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">chrome-devtools-protocol</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">chromedevtoolsprotocol</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">browser</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">browser-automation</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">web-scraper</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">spider</button></a>
                </span>
            
        </p>
        
            <p class="pkg-desc">Low-level Nim wrapper for Chrome DevTools Protocol (CDP) v1.3 stable. Bend Chrome to your will with complete control over your browser. Scrape dynamic webpages, create browser automations, and beyond.</p>
        
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install cdp" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h1>ChromeDevToolsProtocol</h1>
<p>Low-level Nim wrapper for <a href="https://chromedevtools.github.io/devtools-protocol/1-3/">Chrome DevTools Protocol (CDP) v1.3 stable</a>.</p>
<p><em>  <strong>Bend Chrome to your will</strong></em> with complete control over your browser. Scrape dynamic webpages, create browser automations, and beyond. Wield responsibly ;)</p>
<blockquote>
<p><strong>Chrome v112 or higher recommended</strong>. <a href="https://developer.chrome.com/docs/chromium/new-headless">It&apos;s better</a>,
as the new <code>headless</code> flag uses the same browser binary rather than a completely seperate implemenation. It&apos;s likely your version of Chrome already has a more recent version.</p>
</blockquote>
<p>This library is cross-platform (Windows, Mac, Linux) and supports both the C and C++ backends.</p>
<h4>NOTE:</h4>
<p><code>cdp</code> is intended to be a low-level wrapper of CDP for use in a webcrawler and a few browser automation projects for my company <a href="https://www.seo.science">SEO Science</a>. We only target v1.3 stable version of CDP as we want to reduce the
amount of maintenance overhead, and ensure reliability of the library in
production use.</p>
<p>We may include some of the experimental Domains, methods, and events in the future. <strong>PRs welcome</strong>.</p>
<p>If you would like to use an experimental feature (like the <a href="https://chromedevtools.github.io/devtools-protocol/tot/Animation/">Animation Domain</a>), you certainly can via the <code>sendCommand</code> procedure. <a href="#using-experimental-features">Details below</a>.</p>
<h2>Dependencies</h2>
<p><strong>A Chrome browser</strong>. Pretty cool right? No webdriver binary. No other dependencies outside of what you probably already have on your system.</p>
<p>  <em>In the future, we do plan to add support for Chromium and Edge.</em></p>
<h2>Installation</h2>
<p>Install from nimble: <code>nimble install cdp</code></p>
<p>Alternatively clone via git: <code>git clone https://github.com/Niminem/ChromeDevToolsProtocol</code></p>
<h2>Basic Usage</h2>
<p>Check out the <a href="https://github.com/Niminem/ChromeDevToolsProtocol/tree/main/tests">tests directory</a> for more examples.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">std</span><span class="op">/</span>[<span class="ide">json</span>, <span class="ide">asyncdispatch</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">cdp</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">main</span>() {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span></div></div><div class="line"><div class="line-content">        <span class="ide">browser</span> <span class="op">=</span> <span class="ide">await</span> <span class="ide">launchBrowser</span>() <span class="com"># launch a new browser</span></div></div><div class="line"><div class="line-content">        <span class="ide">tab</span> <span class="op">=</span> <span class="ide">await</span> <span class="ide">browser</span><span class="op">.</span><span class="ide">newTab</span>() <span class="com"># open a new tab</span></div></div><div class="line"><div class="line-content">    <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">enablePageDomain</span>() <span class="com"># enable the Page domain (for monitoring page events)</span></div></div><div class="line"><div class="line-content">    <span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">navigate</span>(<span class="str">&quot;https://github.com/Niminem&quot;</span>) <span class="com"># navigate to a page</span></div></div><div class="line"><div class="line-content">    <span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">browser</span><span class="op">.</span><span class="ide">waitForSessionEvent</span>(<span class="ide">tab</span><span class="op">.</span><span class="ide">sessionId</span>, <span class="op">$</span><span class="ide">Page</span><span class="op">.</span><span class="ide">domContentEventFired</span>) <span class="com"># wait for page to load</span></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span></div></div><div class="line"><div class="line-content">        <span class="ide">resp</span> <span class="op">=</span> <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">evaluate</span>(<span class="str">&quot;document.title&quot;</span>, <span class="op">%*</span>{<span class="str">&quot;returnByValue&quot;</span>: <span class="ide">true</span>}) <span class="com"># evaluate a script on the page</span></div></div><div class="line"><div class="line-content">        <span class="ide">title</span> <span class="op">=</span> <span class="ide">resp</span>[<span class="str">&quot;result&quot;</span>][<span class="str">&quot;result&quot;</span>][<span class="str">&quot;value&quot;</span>]<span class="op">.</span><span class="ide">to</span>(<span class="ide">string</span>) <span class="com"># get the title of the page</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Title of the page: &quot;</span>, <span class="ide">title</span> <span class="com"># Title of the page: Niminem (Leon Lysak) · GitHub</span></div></div><div class="line"><div class="line-content">    <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">disablePageDomain</span>() <span class="com"># disable the Page domain</span></div></div><div class="line"><div class="line-content">    <span class="ide">await</span> <span class="ide">browser</span><span class="op">.</span><span class="ide">close</span>() <span class="com"># close the browser / cdp, websocket, delete userdatadir, terminate browser process</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">waitFor</span> <span class="ide">main</span>()</div></div>  </code></pre>
<h2>Getting Started With CDP</h2>
<p>I highly recommend reading Aslushnikov&apos;s <a href="https://github.com/aslushnikov/getting-started-with-cdp">README</a> on using Chrome DevTools Protocol as a quick primer. I&apos;ll try my best to explain the concepts
and how they relate to this API.</p>
<h3>Introduction</h3>
<p>The Chrome DevTools Protocol allows for tools to instrument, inspect, debug and profile Chromium, Chrome and other Blink-based browsers (like Microsoft Edge).</p>
<p>Even Chrome DevTools uses this protocol and the team maintains its API.</p>
<h3>Protocol Fundamentals</h3>
<p>When Chrome is started with a <code>--remote-debugging-port=&lt;number&gt;</code> flag, it starts a Chrome DevTools Protocol server and creates a WebSocket URL. Clients can create a WebSocket to connect to the URL and start sending CDP commands.</p>
<p>Chrome DevTools protocol is mostly based on <a href="https://www.jsonrpc.org/specification">JSONRPC</a>- each comand is a JSON object with an <code>id</code>, a <code>method</code>, and an optional <code>params</code> (JSON object).</p>
<p>A few things to keep in mind:</p>
<ul>
<li>Every command that is sent over to CDP must have a unique <code>id</code> parameter. Message responses will be delivered over websocket and will have the same <code>id</code>.</li>
<li>Incoming WebSocket messages <em>without</em> an <code>id</code> parameter are <strong>protocol events</strong>.</li>
<li>Message order is important in CDP. For example, protocol events that occur as the result of a CDP command will be reported before the response to that CDP command.</li>
<li>There&apos;s a top-level &quot;browser&quot; target that always exists. More on this in the <a href="#targets--sessions">next section</a>.</li>
</ul>
<p>This library provides a level of abstraction by wrapping the various CDP commands (methods) in v1.3 stable:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Navigates current page (tab) to the given URL.</span></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">navigate</span>(<span class="ide">tab</span>: <span class="ide">Tab</span>; <span class="ide">url</span>: <span class="ide">string</span>; <span class="ide">params</span>: <span class="ide">JsonNode</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">navigate</span>(<span class="ide">tab</span>: <span class="ide">Tab</span>; <span class="ide">url</span>: <span class="ide">string</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>]</div></div><div class="line"><div class="line-content"><span class="com"># reference: https://chromedevtools.github.io/devtools-protocol/1-3/Page/#method-navigate</span></div></div>  </code></pre>
<p><code>cdp</code> also abstracts away other things, like the management of the unique <code>id</code> parameter for commands.</p>
<h3>Targets &amp; Sessions</h3>
<p>Chrome DevTools protocol has APIs to interact with many different parts of the browser - such as pages (this library refers to them as <em>tabs</em>), serviceworkers and extensions. These parts are called <strong>Targets</strong> and can be fetched/tracked using the <a href="https://chromedevtools.github.io/devtools-protocol/1-3/Target/">Target domain</a>.</p>
<p>When a client wants to interact with a target using CDP, it has to first attach to the target using <code>Target.attachToTarget</code> command. The command will establish a protocol session to the given target and return a <code>sessionId</code>.</p>
<p>In order to submit a CDP command to the target, every message should also include a <code>sessionId</code> parameter next to the usual JSONRPC’s <code>id</code>.</p>
<p>This library provides a level of abstraction for a page (tab) target:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="op">...</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">tab</span> <span class="op">=</span> <span class="ide">await</span> <span class="ide">browser</span><span class="op">.</span><span class="ide">newTab</span>() <span class="com"># opens a new page (tab)</span></div></div><div class="line"><div class="line-content"><span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">navigate</span>(<span class="str">&quot;https://github.com/Niminem&quot;</span>) <span class="com"># navigate to a page</span></div></div><div class="line"><div class="line-content"><span class="op">...</span></div></div>  </code></pre>
<p>With <code>browser.newTab()</code>, the procedure will create a target (page), attach to it, and the sessionId (a field of
the returned <code>Tab</code> object) will be used in all future commands from the <code>Tab</code>.</p>
<p>Some commands <strong>set state</strong> which is stored <strong>per session</strong> (ex: <code>Runtime.enable</code> and <code>Targets.setDiscoverTargets</code>). Each session is initialized with a set of domains, the exact set depends on the attached target. For example, sessions connected to a browser don&apos;t have a &quot;Page&quot; domain, but sessions connected to pages do.</p>
<p>We call sessions attached to a Browser target <em>browser sessions</em>. Similarly, there are <em>page sessions</em>, <em>worker sessions</em> and so on. In fact, the WebSocket connection is an implicitly created <strong>browser session</strong>.</p>
<p>Although this library currently provides an abstraction over a Page target (tab) and the implicit Browser target, you can create other targets with the generic <code>sendCommand</code> procedure. More on this <a href="#using-experimental-features">below</a>.</p>
<h3>Session Hierarchy</h3>
<p>When a client connects over the WebSocket to the launched Chrome browser, a <em>root</em> browser session is created. This session is the one that receives commands if there&apos;s no <code>sessionId</code> specified. Essentially, this refers to the <code>Browser</code> object returned from the <code>launchBrowser</code> procedure. Later on, when the root browser session is used to attach to a page target, a new page session created (the <code>Tab</code> object).</p>
<p>The page session is created from inside the browser session and thus is a <strong>child</strong> of the browser session. When a parent session closes (ex: <code>Target.detachFromTarget</code>), all of its child sessions are closed as well.</p>
<p>As of <code>cdp</code> 0.1.0, the <code>browser.close()</code> procedure will close the browser session (thus closing all of the child sessions).
More granular closing procedures must be implemented on your end for now.</p>
<h3>Stable vs Experimental methods</h3>
<p>The Chrome DevTools Protocol has stable and experimental parts. Events, methods, and sometimes whole domains might be marked as experimental. DevTools team doesn&apos;t commit to maintaining experimental APIs and changes/removes them regularly.</p>
<p>  <strong>!!! USE EXPERIMENTAL APIS AT YOUR OWN RISK !!!</strong></p>
<p>As history has shown, experimental APIs do change quite often. If possible, stick to the stable protocol (the wrapped commands
and events from this library).</p>
<h2>API Overview</h2>
<p>Check out the full API documentation <a href="https://niminem.github.io/CDP/cdp.html">here</a>.</p>
<h3>The Browser Object</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">launchBrowser</span><span class="op">*</span>(<span class="ide">userDataDir</span> <span class="op">=</span> <span class="str">&quot;&quot;</span>;</div></div><div class="line"><div class="line-content">                    <span class="ide">portNo</span> <span class="op">=</span> <span class="num">0</span>; <span class="ide">headlessMode</span> <span class="op">=</span> <span class="ide">HeadlessMode</span><span class="op">.</span><span class="ide">On</span>;</div></div><div class="line"><div class="line-content">                    <span class="ide">chromeArguments</span>: <span class="ide">seq</span>[<span class="ide">string</span>] <span class="op">=</span> <span class="op">@</span>[]): <span class="ide">Future</span>[<span class="ide">Browser</span>] {<span class="op">.</span><span class="ide">async</span>}</div></div>  </code></pre>
<p>Using the <code>cdp</code> library begins with <code>Browser</code> instance.</p>
<p>Use this Browser instance (browser Target / browser session) to interact with the appropriate CDP domains/methods.</p>
<p><code>launchBrowser</code> Launches a new Chrome browser instance and returns a <code>Browser</code> object.</p>
<ul>
<li><code>userDataDir</code> parameter can be used to specify a directory where the
browser&apos;s user data will be stored. If an empty string is passed, a temporary</li>
</ul>
<p>directory will be created and used.</p>
<ul>
<li>
<p><code>portNo</code> parameter can be used to specify a port number for the browser to
listen on. If <code>portNo</code> is 0, Chrome will choose a random port.</p>
</li>
<li>
<p><code>headlessMode</code> parameter can be used to specify whether the browser should be
launched in headless mode or not. <code>HeadlessMode.On</code> (the default) will launch</p>
</li>
</ul>
<p>the new version of Chrome headless mode (for Chrome &gt;= v112). <strong>Use <code>HeadlessMode.Legacy</code>
to launch the browser in headless mode for Chrome &lt; v112.</strong> The new headless mode is
recommended as the old version of headless mode will be deprecated, and the new version
is the actual browser rather than a separate browser implementation.</p>
<ul>
<li><code>chromeArguments</code> parameter can be used to pass additional arguments to the
Chrome browser instance. For a list of all available arguments, see:</li>
</ul>
<p>https://peter.sh/experiments/chromium-command-line-switches/ or
https://github.com/puppeteer/puppeteer/blob/main/packages/puppeteer-core/src/node/ChromeLauncher.ts
for a list of arguments used by Puppeteer (a high-level API for CDP using NodeJs).</p>
<p>The following command-line arguments are <em>always</em> passed to Chrome:</p>
<ul>
<li>  <code>--remote-debugging-port=&lt;portNo&gt;</code></li>
<li>  <code>--user-data-dir=&lt;userDataDir&gt;</code></li>
<li>  <code>--no-first-run</code></li>
<li><code>--headless=new</code> or <code>--headless</code> (if <code>headlessMode</code> is <code>HeadlessMode.On</code> (default) or <code>HeadlessMode.Legacy</code>).
If <code>HeadlessMode.Off</code> is passed, Chrome will open a visible window.</li>
</ul>
<p>  <strong>IMPORANT: Make sure you call   <code>browser.close()</code> before quitting or ending your program or else you will have a   <a href="https://nim-lang.org/docs/osproc.html#close%2CProcess">zombie process</a>.</strong></p>
<h3>The Tab Object</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">newTab</span><span class="op">*</span>(<span class="ide">browser</span>: <span class="ide">Browser</span>): <span class="ide">Future</span>[<span class="ide">Tab</span>] {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div>  </code></pre>
<p><code>newTab</code> procedure creates a new tab (Page) with the browser instance and returns a <code>Tab</code> object.</p>
<p>Use this <code>Tab</code> object to interact with a page session. You can monitor and intercept network events, execute javascript, and so much more via enabling the appropriate domains. Page sessions will be used the most.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Pulled from the &apos;Basic Usage&apos; example above</span></div></div><div class="line"><div class="line-content"><span class="op">...</span></div></div><div class="line"><div class="line-content"><span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">enablePageDomain</span>() <span class="com"># enable the Page domain (for monitoring page events)</span></div></div><div class="line"><div class="line-content"><span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">navigate</span>(<span class="str">&quot;https://github.com/Niminem&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">browser</span><span class="op">.</span><span class="ide">waitForSessionEvent</span>(<span class="ide">tab</span><span class="op">.</span><span class="ide">sessionId</span>, <span class="op">$</span><span class="ide">Page</span><span class="op">.</span><span class="ide">domContentEventFired</span>) <span class="com"># wait for page to load</span></div></div><div class="line"><div class="line-content"><span class="op">...</span></div></div><div class="line"><div class="line-content"><span class="com"># It&apos;s good practice to disable the domain when you are done</span></div></div><div class="line"><div class="line-content"><span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">disablePageDomain</span>()</div></div><div class="line"><div class="line-content"><span class="op">...</span></div></div>  </code></pre>
<p>Enabling the <strong>Page Domain</strong> allows you monitor page events, such as the <code>domContentEventFired</code> event. With this access you
can, for example, scape various parts of a web page after the DOM is ready. Some Domains may need to be enabled in order to use them like
this one. In the <a href="https://niminem.github.io/CDP/cdp.html">API documentation</a>, I&apos;ve provided direct references to each
domain and each domain&apos;s methods/events.</p>
<p>Notice the <code>tab.navigate</code> call. This is a wrapped method for the Tab object, directly corresponding to the <a href="https://chromedevtools.github.io/devtools-protocol/1-3/Page/#method-navigate">navigate CDP
method</a>. ALL CDP methods and events for browser and page targets have been wrapped for v1.3 stable.</p>
<h3>Global &amp; Session Event Callbacks</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">SessionId</span><span class="op">*</span> <span class="op">=</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">ProtocolEvent</span><span class="op">*</span> <span class="op">=</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">EventCallback</span><span class="op">*</span> <span class="op">=</span> <span class="kwd">proc</span>(<span class="ide">data</span>: <span class="ide">JsonNode</span>) {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div><div class="line"><div class="line-content"><span class="com"># Adds a callback function to the global event table for the specified event</span></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">addGlobalEventCallback</span><span class="op">*</span>(<span class="ide">browser</span>: <span class="ide">Browser</span>; <span class="ide">event</span>: <span class="ide">ProtocolEvent</span>; <span class="ide">cb</span>: <span class="ide">EventCallback</span>)</div></div><div class="line"><div class="line-content"><span class="com"># Adds a callback function to the session event table for the specified event.</span></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">addSessionEventCallback</span><span class="op">*</span>(<span class="ide">browser</span>: <span class="ide">Browser</span>; <span class="ide">sessionId</span>: <span class="ide">SessionId</span>;</div></div><div class="line"><div class="line-content">                              <span class="ide">event</span>: <span class="ide">ProtocolEvent</span>; <span class="ide">cb</span>: <span class="ide">EventCallback</span>)</div></div><div class="line"><div class="line-content"><span class="com"># Returns a `Future` that completes when the specified global event is received.</span></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">waitForGlobalEvent</span><span class="op">*</span>(<span class="ide">browser</span>: <span class="ide">Browser</span>; <span class="ide">event</span>: <span class="ide">ProtocolEvent</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>] {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div><div class="line"><div class="line-content"><span class="com"># Returns a `Future` that completes when the specified session event is received.</span></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">waitForSessionEvent</span><span class="op">*</span>(<span class="ide">browser</span>: <span class="ide">Browser</span>; <span class="ide">sessionId</span>: <span class="ide">string</span>;</div></div><div class="line"><div class="line-content">                          <span class="ide">event</span>: <span class="ide">ProtocolEvent</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>] {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div>  </code></pre>
<p>As of <code>cdp</code> 0.1.0, there are two kinds of callbacks- one for handling <strong>Global events</strong> (those without an <code>id</code> parameter)
and the other for <strong>Session events</strong> (those corresponding to a session, like a Tab/Page, which have a <code>sessionId</code> parameter).</p>
<p>There are two ways you can use them.</p>
<p>Either you register a callback procedure that executes each time the CDP event occurs via <code>addGlobalEventCallback</code> or <code>addSessionEventCallback</code>, or you can use the <code>waitFor</code> variant. <code>waitFor</code> should be used to suspend execution until the event occurs, like the example above where we waited for <code>Page.domContentEventFired</code> before interacting with the tab.</p>
<p>  <strong>NOTE: Currently, there can only be one callback per   <em>Global event</em>, and only one callback per event for
each session for   <em>Session events</em>. If you try adding another callback for the same global/session event, the current callback will be overwritten.</strong></p>
<p><code>deleteGlobalEventCallback</code> and <code>deleteSessionEventCallback</code> can be called to delete the event callbacks.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">std</span><span class="op">/</span>[<span class="ide">json</span>, <span class="ide">asyncdispatch</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">cdp</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">logGlobalEvent</span>(<span class="ide">event</span>: <span class="ide">JsonNode</span>) {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>} <span class="op">=</span> <span class="ide">echo</span> <span class="str">&quot;Logging Global Event: &quot;</span> <span class="op">&amp;</span> <span class="ide">event</span>[<span class="str">&quot;method&quot;</span>]<span class="op">.</span><span class="ide">to</span>(<span class="ide">string</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">logSessionEvent</span>(<span class="ide">event</span>: <span class="ide">JsonNode</span>) {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>} <span class="op">=</span> <span class="ide">echo</span> <span class="str">&quot;Logging Session Event: &quot;</span> <span class="op">&amp;</span> <span class="ide">event</span>[<span class="str">&quot;method&quot;</span>]<span class="op">.</span><span class="ide">to</span>(<span class="ide">string</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">main</span>() {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">experimentalGlobalEvent</span> <span class="op">=</span> <span class="str">&quot;Target.attachedToTarget&quot;</span></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">browser</span> <span class="op">=</span> <span class="ide">await</span> <span class="ide">launchBrowser</span>()</div></div><div class="line"><div class="line-content">    <span class="ide">browser</span><span class="op">.</span><span class="ide">addGlobalEventCallback</span>(<span class="ide">experimentalGlobalEvent</span>, <span class="ide">logGlobalEvent</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">tab</span> <span class="op">=</span> <span class="ide">await</span> <span class="ide">browser</span><span class="op">.</span><span class="ide">newTab</span>()</div></div><div class="line"><div class="line-content">    <span class="ide">browser</span><span class="op">.</span><span class="ide">addSessionEventCallback</span>(<span class="ide">tab</span><span class="op">.</span><span class="ide">sessionId</span>, <span class="op">$</span><span class="ide">Page</span><span class="op">.</span><span class="ide">frameNavigated</span>, <span class="ide">logSessionEvent</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">enablePageDomain</span>()</div></div><div class="line"><div class="line-content">    <span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">navigate</span>(<span class="str">&quot;https://github.com/Niminem&quot;</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">disablePageDomain</span>()</div></div><div class="line"><div class="line-content">    <span class="ide">browser</span><span class="op">.</span><span class="ide">deleteGlobalEventCallback</span>(<span class="ide">experimentalGlobalEvent</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">browser</span><span class="op">.</span><span class="ide">deleteSessionEventCallback</span>(<span class="ide">tab</span><span class="op">.</span><span class="ide">sessionId</span>, <span class="op">$</span><span class="ide">Page</span><span class="op">.</span><span class="ide">frameNavigated</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">await</span> <span class="ide">browser</span><span class="op">.</span><span class="ide">close</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">waitFor</span> <span class="ide">main</span>()</div></div>  </code></pre>
<h3>Using Experimental Features</h3>
<p><code>cdp</code> wraps all CDP methods via the <code>sendCommand</code> procedure.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">sendCommand</span><span class="op">*</span>(<span class="ide">browser</span>: <span class="ide">Browser</span>; <span class="ide">mthd</span>: <span class="ide">string</span>; <span class="ide">params</span>: <span class="ide">JsonNode</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>] {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">sendCommand</span><span class="op">*</span>(<span class="ide">browser</span>: <span class="ide">Browser</span>; <span class="ide">mthd</span>: <span class="ide">string</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>] {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">sendCommand</span><span class="op">*</span>(<span class="ide">tab</span>: <span class="ide">Tab</span>; <span class="ide">mthd</span>: <span class="ide">string</span>; <span class="ide">params</span>: <span class="ide">JsonNode</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>] {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">sendCommand</span><span class="op">*</span>(<span class="ide">tab</span>: <span class="ide">Tab</span>; <span class="ide">mthd</span>: <span class="ide">string</span>): <span class="ide">Future</span>[<span class="ide">JsonNode</span>] {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>}</div></div>  </code></pre>
<p>Wrapped CDP method example:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">deleteCookies</span><span class="op">*</span>(<span class="ide">tab</span>: <span class="ide">Tab</span>; <span class="ide">name</span>: <span class="ide">string</span>; <span class="ide">params</span>: <span class="ide">JsonNode</span>) {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>} <span class="op">=</span> <span class="com"># optional params exist</span></div></div><div class="line"><div class="line-content">    <span class="ide">params</span>[<span class="str">&quot;name&quot;</span>] <span class="op">=</span> <span class="ide">newJString</span>(<span class="ide">name</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">sendCommand</span>(<span class="str">&quot;Network.deleteCookies&quot;</span>, <span class="ide">params</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">deleteCookies</span><span class="op">*</span>(<span class="ide">tab</span>: <span class="ide">Tab</span>; <span class="ide">name</span>: <span class="ide">string</span>) {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>} <span class="op">=</span> <span class="com"># only &apos;name&apos; parameter is required</span></div></div><div class="line"><div class="line-content">    <span class="kwd">discard</span> <span class="ide">await</span> <span class="ide">tab</span><span class="op">.</span><span class="ide">sendCommand</span>(<span class="str">&quot;Network.deleteCookies&quot;</span>, <span class="op">%*</span>{<span class="str">&quot;name&quot;</span>: <span class="ide">name</span>})</div></div>  </code></pre>
<p>You can easily use any experimental method with this generic procedure.</p>
<p>Similarly, you can easily use any experimental <em>CDP event</em> with the callback functions as they are just strings.
<code>cdp</code> provides enums for <em>stable</em> events as a convenience so I don&apos;t accidently shoot myself in the foot:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">Network</span><span class="op">*</span> {<span class="op">.</span><span class="ide">pure</span><span class="op">.</span>} <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">        <span class="ide">dataReceived</span> <span class="op">=</span> <span class="str">&quot;Network.dataReceived&quot;</span>,</div></div><div class="line"><div class="line-content">        <span class="ide">eventSourceMessageReceived</span> <span class="op">=</span> <span class="str">&quot;Network.eventSourceMessageReceived&quot;</span>,</div></div><div class="line"><div class="line-content">        <span class="ide">loadingFailed</span> <span class="op">=</span> <span class="str">&quot;Network.loadingFailed&quot;</span>,</div></div><div class="line"><div class="line-content">        <span class="op">...</span></div></div><div class="line"><div class="line-content"><span class="com"># used like this:</span></div></div><div class="line"><div class="line-content"><span class="op">...</span></div></div><div class="line"><div class="line-content"><span class="ide">browser</span><span class="op">.</span><span class="ide">addGlobalEventCallback</span>(<span class="op">$</span><span class="ide">Network</span><span class="op">.</span><span class="ide">dataReceived</span>, <span class="ide">procName</span>)</div></div><div class="line"><div class="line-content"><span class="op">...</span></div></div><div class="line"><div class="line-content"><span class="com"># alternatively for experimental events:</span></div></div><div class="line"><div class="line-content"><span class="op">...</span></div></div><div class="line"><div class="line-content"><span class="ide">browser</span><span class="op">.</span><span class="ide">addGlobalEventCallback</span>(<span class="str">&quot;Target.attachedToTarget&quot;</span>, <span class="ide">procName</span>)</div></div><div class="line"><div class="line-content"><span class="op">..</span></div></div>  </code></pre>
<h3>Other API Notes</h3>
<ul>
<li>
<p>ALL commands provide a generic <code>Future[Json]</code> response containing the <code>id</code> of the method called. This is how we can map sent commands to the appropriate responses as CDP is a single multiplexed web socket connection (I think I said that right). Anyways, use the <code>discard</code> statement as necessary.</p>
</li>
<li>
<p>If any commands should have a non-generic response (aka something you need to parse and use), it is still of
the same <code>Future[Json]</code> type. This is because some CDP <code>return objects</code> return optional
parameters. Example: <a href="https://chromedevtools.github.io/devtools-protocol/1-3/DOM/">DOM.getNodeForLocation</a>.
There is no efficient way to directly map them all into their return objects.</p>
</li>
<li>
<p>Exception handling is basic, accounting mostly for setup and Chrome process stuff. For now, you have to roll your own for CDP methods. I&apos;m certain that CDP provides error message/description in the responses you receive.</p>
</li>
<li>
<p>There is no getting around it. You&apos;ll need to become familiar with CDP itself and what the different domains/events provide (depending on what you&apos;re trying to accomplish of course), but when you do- you will have complete control over your browser. The only limit will be your imagination.</p>
</li>
</ul>
<h2>Todo List:</h2>
<ul>
<li>Look into basic exception handling for errors in CDP responses</li>
<li>Add support for Chromium (Windows and Mac as this exists for Linux) and Microsoft Edge (Windows)</li>
<li>Add <code>close</code> procedure for <code>Tab</code> (I think we should destroy the object after it&apos;s dettached from the target)</li>
<li>Add convenience functions for handling global/session events with the <code>Tab</code> object</li>
<li>Investigate if there&apos;s a need for supporting multiple global and session events (my inclination is no)</li>
</ul>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        MIT
                    </p>
                

                
                    <p> <a href="https://github.com/Niminem/ChromeDevToolsProtocol">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2024-07-21T01:24:15Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
